# 输入 url 到页面显示发生了什么？

这是一篇关于 `输入 url 到页面显示发生了什么？` 的笔记。

下面是此笔记整体的一个概述，后续由于涉及到的知识层面很多。会不断填充此笔记。

## 概述

知识点分为两部分

- **网络通信**

  湖南科技大学-计算机网络 [学银在线](http://www.xueyinonline.com/detail/216843891) / [中国大学 MOOC（慕课）](https://www.icourse163.org/course/HNKJ-1461816178) / [BiliBili](https://www.bilibili.com/video/BV1c4411d7jb)

  书籍[《网络是怎样连接的》](../../resources/网络是怎样连接的.pdf)

- **浏览器渲染**

  [Google Developers](https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-tree-construction?hl=zh-cn)

### 网络通信

首先开始网络通信，具体过程如下图

![网络是怎样连接的](.\网络是怎样连接的.png)

_图 1 来源书籍《网络是怎样连接的》_

1.  Web 浏览器

从在浏览器中输入网址（URL）开始的。例如，当我们输入下面这样的网址
http://www.lab.glasscom.com/sample1.html

浏览器生成的请求消息表示“请给我 `sample1.html` 这一文件中储存的网页数据”。即委托操作系统中的网络控制软件将消息发送给服务器。

2. 协议栈、网卡

   `协议栈` 将从浏览器接收到的消息打包，加上目的地址等控制信息，然后将包交给网卡（负责以太网或无线网络通信的硬件）。然后，网卡会将包转换为电信号并通过网线发送出去。这样一来，包就进入到网络之中了。

3. 集线器、交换机、路由器

   网卡发送的包会经过交换机等设备，到达用来接入互联网的路由器。路由器的后面就是互联网，网络运营商会负责将包送到目的地。

4. 接入网、网络运营商

   数据从用来接入互联网的路由器出发，进入了互联网的内部。互联网的入口线路称为 `接入网`。网络包首先通过接入网被发送到接入点，然后再从这里被发送到全国甚至全世界。接入点的后面就是互联网的骨干部分了。

5. 防火墙、缓存服务器

   通过 `骨干网` 之后，网络包最终到达了 Web 服务器所在的局域网中。接着，它会遇到防火墙，防火墙会对进入的包进行检查。

   检查完之后，网络包接下来可能还会遇到 `缓存服务器`。网页数据中有一部分是可以重复利用的，这些可以重复利用的数据就被保存在缓存服务器中。

6. Web 服务器

当网络包到达 Web 服务器后，数据会被解包并还原为原始的请求消息，然后交给 Web 服务器程序。和客户端一样，这个操作也是由操作系统中的协议栈（网络控制软件）来完成的。

接下来，Web 服务器程序分析请求消息的含义，并按照其中的指示将数据装入响应消息中，然后发回给客户端。响应消息回到客户端的过程和之前我们介绍的过程正好相反。

当响应到达客户端之后，浏览器会从中读取出网页的数据并在屏幕上显示出来。到这里，访问 Web 服务器的一系列操作就全部完成了。

### 浏览器渲染

下面简要概述了浏览器完成的步骤:

1. 处理 HTML 标记并构建 DOM 树。

2. 处理 CSS 标记并构建 CSSOM 树。

3. 将 DOM 与 CSSOM 合并成一个渲染树。

4. 根据渲染树来布局，以计算每个节点的几何信息。

5. 将各个节点绘制到屏幕上。

浏览器渲染页面前需要先构建 `DOM` 和 `CSSOM` 树。

- 字节 → 字符 → 令牌 → 节点 → 对象模型。

![](.\full-process.png)

渲染树构建、布局及绘制

CSSOM 树和 DOM 树合并成渲染树，然后用于计算每个可见元素的布局，并输出给绘制流程，将像素渲染到屏幕上。

![](.\render-tree-construction.png)

---

## 开始

![a](.\网络体系结构.jpg)

常见的网络体系结构

### 网络通信

#### Web 浏览器

##### 1. HTTP 请求

故事从浏览器地址栏 `https://www.baidu.com/` 说起。

浏览器开始请求 `www.baidu.com `根目录下的`index`文件，生成 `HTTP`消息。

##### 2. DNS

> **DNS：Domain Name System**，域名服务系统。将服务器名称和 IP 地址进行关联是 DNS 最常见的用法，但 DNS 的功能并不仅限于此，它还可以将邮件地址和邮件服务器进行关联，以及为各种信息关联相应的名称。

但是根据 `域名`是找不到对应的服务器的，所以需要查询网址中对应服务器域名的  `IP` 地址。

方法也很简单只要询问最近的 DNS 服务器 `www.lab.glasscom.com` 的 `IP` 地址是什么。

> 对于 DNS 服务器，我们的计算机上一定有相应的 DNS 客户端，而相当于 DNS 客户端的部分称为 DNS 解析器，或者简称解析器。通过 DNS 查询 IP 地址的操作称为域名解析，因此负责执行解析（resolution）这一操作的就叫解析器（resolver）了。

调用解析器后，解析器会向 DNS 服务器发送查询消息，然后 DNS 服务器会返回响应消息。响应消息中包含查询到的 IP 地址，解析器会取出 IP 地址，并将其写入浏览器指定的内存地址中。

**拿到 IP 可并没有那么容易**，下面看看内部：

![](.\解析器内部.jpg)

*解析器内部*

解析器委托操作系统内部的协议栈来发送`UDP`请求，通过网卡发送到最近的 `DNS`服务器。

**DNS 服务器会从域名与IP 地址的对照表中查找相应的记录，并返回IP 地址。**

如果有缓存则直接返回，要是没有的话，这台 `DNS` 服务器，就去问他的老大 `根 DNS`，如下图，

![找到根服务器](.\找到目标DNS服务器.jpg)

结合 url 来看， `www.lab.glasscom.com.` 注意 url 最后的一个点，那个点就是跟域。一般默认不写。从右到左一直寻找，知道找到 IP。

上图只是整体的一个流程，DNS 服务器之间的查询操作原理，如下图

![](.\DNS 服务器之间的查询操作.jpg)



实际上，有时候一个 DNS 服务器会管理多个域，可以直接跳过一级。有时候不需要从跟域开始，因为 DNS 服务器有缓存功能，结果不存在也会被缓存起来，当然缓存会有一个有效期。

**至此已经拿到网址对应的 IP。**

##### 3. 协议栈、网卡

##### 1. TCP/IP

##### 2. UDP

#### 集线器、交换机、路由器

##### 1. 集线器传输

##### 2. 交换机的转发操作

##### 3. 路由器的转发操作

#### 接入网、网络运营商

#### 防火墙、缓存服务器

#### Web 服务器

---

### 浏览器渲染
